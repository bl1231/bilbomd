# -----------------------------------------------------------------------------
# Use this Docker compose file for development deployment on Hyperion
# You may need to create the following volumes before running this file:
#
#  docker volume create bilbomd-mongodb-dev
#  docker volume create bilbomd-redis-cache-dev
#  docker volume create bilbomd-uploads-dev
#  docker volume create bilbomd-logs-dev
#
# You will also need to copy .env.example to .env.dev and maybe adjust some
# of the values in the .env.dev file.
# -----------------------------------------------------------------------------
volumes:
  mongodb:
    name: bilbomd-mongodb-dev
    external: true
  redis-cache:
    name: bilbomd-redis-cache-dev
    external: true
  uploads:
    name: bilbomd-uploads-dev
    external: true
  logs:
    name: bilbomd-logs-dev
    external: true

networks:
  app-network-dev:
    driver: bridge

services:
  # ---------------------------------------------------------------------------
  mongodb:
    image: mongo:7.0.19
    pull_policy: always
    restart: always
    healthcheck:
      test: echo 'db.runCommand({serverStatus:1}).ok' | mongosh admin -u $MONGO_USERNAME -p $MONGO_PASSWORD --quiet | grep 1
      interval: 10s
      timeout: 10s
      retries: 7
      start_period: 20s
    env_file:
      - .env.dev
    environment:
      MONGO_INITDB_ROOT_USERNAME: $MONGO_USERNAME
      MONGO_INITDB_ROOT_PASSWORD: $MONGO_PASSWORD
    ports:
      - "${MONGO_DEV_BIND_ADDR:?err}:${MONGO_EXTERNAL_PORT:?err}:27017"
    volumes:
      - mongodb:/data/db
    networks:
      - app-network-dev

  # ---------------------------------------------------------------------------
  redis:
    image: redis:7.4.2
    pull_policy: always
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    env_file:
      - path: .env.dev
    ports:
      - "${REDIS_DEV_BIND_ADDR:?err}:${REDIS_EXTERNAL_PORT:?err}:6379"
    command: redis-server --save 20 1 --loglevel warning
    volumes:
      - redis-cache:/data
    networks:
      - app-network-dev

  # ---------------------------------------------------------------------------
  backend:
    image: ghcr.io/bl1231/bilbomd-backend:1.19.2
    pull_policy: always
    deploy:
      resources:
        limits:
          cpus: "12"
    restart: always
    env_file:
      - path: .env.dev
    ports:
      - "${BILBOMD_DEV_BIND_ADDR:?err}:${BILBOMD_BACKEND_PORT:?err}:3500"
    volumes:
      # These are bind mounts that are used for local development
      - ./bilbomd-backend:/app
      - ./uploads-dev:/bilbomd/uploads
      - ./logs/backend:/bilbomd/logs
      - ./backend-dev-tmp/config:/.config
      - ./backend-dev-tmp/cache:/.cache
      # Alternatively you can use these Docker volumes
      # - uploads:/bilbomd/uploads
      # - logs:/bilbomd/logs
    networks:
      - app-network-dev
    user: "${UID:-1001}:${GID:-1001}"
    # command: ["npm", "run", "dev"]
    depends_on:
      - mongodb
      - redis
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:3500/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  worker:
    image: ghcr.io/bl1231/bilbomd-worker:1.14.0
    pull_policy: always
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: "12"
    restart: no
    env_file:
      - path: .env.dev
    networks:
      - app-network-dev
    volumes:
      # These are bind mounts that are used for local development
      - ./bilbomd-worker:/app # comment out to use beackend code in Docker image
      - ./uploads-dev:/bilbomd/uploads
      # - ./secrets:/secrets
      - ./logs/worker:/bilbomd/logs
      # Alternatively you can use these Docker volumes
      # - uploads:/bilbomd/uploads
      # - logs:/bilbomd/logs
    user: "${UID:-1001}:${GID:-1001}"
    # command: [ "npm", "run", "dev" ]
    depends_on:
      - mongodb
      - redis
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:3000/config"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  scoper:
    image: ghcr.io/bl1231/bilbomd-scoper:latest
    # pull_policy: always
    # build:
    #   context: ./bilbomd-scoper
    #   args:
    #     USER_ID: 62704
    #     GROUP_ID: 1001
    #     NODE_MAJOR: 20
    #     GITHUB_TOKEN: $GITHUB_TOKEN
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: "12"
    restart: no
    env_file:
      - path: .env.dev
    networks:
      - app-network-dev
    volumes:
      # These are bind mounts that are used for local development
      - ./bilbomd-scoper:/home/scoper/app
      - ./uploads-dev:/bilbomd/uploads
      - ./logs/backend:/bilbomd/logs
      # - uploads:/bilbomd/uploads
      # - logs:/bilbomd/logs
    user: "${UID:-1001}:${GID:-1001}"
    depends_on:
      - mongodb
      - redis
      - backend

  # ---------------------------------------------------------------------------
  ui:
    image: ghcr.io/bl1231/bilbomd-ui:1.19.4
    pull_policy: always
    env_file:
      - .env.dev
    ports:
      - "${BILBOMD_DEV_BIND_ADDR:?err}:${BILBOMD_UI_PORT:?err}:80"
    networks:
      - app-network-dev
    depends_on:
      - backend
      - mongodb
      - redis
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost/version-info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
