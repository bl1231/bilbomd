name: _build-and-push (reusable)

on:
  workflow_call:
    inputs:
      app_id: { required: true, type: string } # backend|worker|ui|scoper
      dockerfile: { required: true, type: string } # e.g. apps/backend/bilbomd-backend.dockerfile
      package_json: { required: true, type: string } # e.g. apps/backend/package.json
      image: { required: true, type: string } # e.g. ghcr.io/${{ github.repository_owner }}/bilbomd-backend
      node_user_arg: { required: false, type: string, default: "USER_ID" }
      node_group_arg: { required: false, type: string, default: "GROUP_ID" }
    secrets:
      ghcr_token:
        required: false # default to GITHUB_TOKEN if not provided

permissions:
  contents: read
  packages: write
  pull-requests: read

jobs:
  build:
    name: Build & Push ${{ inputs.app_id }}
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ inputs.app_id }}-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.ghcr_token || secrets.GITHUB_TOKEN }}

      - name: Read version from package.json
        run: echo "VERSION=$(jq -r .version '${{ inputs.package_json }}')" >> $GITHUB_ENV

      - name: Compute branch + short sha
        run: |
          SAFE_BRANCH=$(echo "${GITHUB_REF_NAME}" | tr '[:upper:]' '[:lower:]' | sed -E 's#[^a-z0-9._-]#-#g')
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-12)
          echo "SAFE_BRANCH=$SAFE_BRANCH" >> $GITHUB_ENV
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV

      - name: Resolve PR number for this branch (if any)
        id: pr
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/')
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const branch = context.ref.replace('refs/heads/', '');
            const prs = await github.rest.pulls.list({ owner, repo, state: 'open', head: `${owner}:${branch}` });
            core.setOutput('number', prs.data.length ? String(prs.data[0].number) : '');

      - name: Docker metadata (tags/labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ inputs.image }}
          tags: |
            # main-only
            type=raw,value=${{ env.VERSION }},enable=${{ github.ref == 'refs/heads/main' }}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            # always
            type=raw,value=${{ github.sha }}
            # PR (event)
            type=raw,value=pr-${{ github.event.pull_request.number }},enable=${{ github.event_name == 'pull_request' }}
            type=raw,value=pr-${{ github.event.pull_request.number }}-${{ env.SHORT_SHA }},enable=${{ github.event_name == 'pull_request' }}
            # PR (branch push w/ open PR)
            type=raw,value=pr-${{ steps.pr.outputs.number }},enable=${{ steps.pr.outputs.number != '' && github.event_name != 'pull_request' }}
            type=raw,value=pr-${{ steps.pr.outputs.number }}-${{ env.SHORT_SHA }},enable=${{ steps.pr.outputs.number != '' && github.event_name != 'pull_request' }}
            # branch (non-main)
            type=raw,value=branch-${{ env.SAFE_BRANCH }}-latest,enable=${{ github.ref != 'refs/heads/main' }}
            type=raw,value=branch-${{ env.SAFE_BRANCH }}-${{ env.SHORT_SHA }},enable=${{ github.ref != 'refs/heads/main' }}

      - name: Build & (conditionally) push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ inputs.dockerfile }}
          # push for push/dispatch; build-only for PR events
          push: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: |
            ${{ steps.meta.outputs.labels }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          build-args: |
            ${{ inputs.node_user_arg }}=${{ vars.USER_ID || '1001' }}
            ${{ inputs.node_group_arg }}=${{ vars.GROUP_ID || '1234' }}
            ${APP_ID^^}_GIT_HASH=${{ github.sha }}
            ${APP_ID^^}_VERSION=${{ env.VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
        env:
          APP_ID: ${{ inputs.app_id }}
